// ---------- Receipt Helpers ----------
function getNextReceiptNumber() {
    let lastNumber = localStorage.getItem("receiptNumber");
    if (!lastNumber) {
        lastNumber = 1;
    } else {
        lastNumber = parseInt(lastNumber) + 1;
    }
    localStorage.setItem("receiptNumber", lastNumber);
    return lastNumber.toString().padStart(4, "0"); // 0001 format
}

function getTodayDate() {
    const today = new Date();
    const dd = String(today.getDate()).padStart(2, '0');
    const mm = String(today.getMonth() + 1).padStart(2, '0'); 
    const yyyy = today.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
}

// ---------- Updated Generate Receipt ----------
function generateReceipt() {
    if (productsArray.length === 0) { 
        alert('Please add at least one product first!'); 
        return; 
    }

    const clientName = document.getElementById('clientName').value || 'Walk-in Customer';
    const productsTotal = productsArray.reduce((s, p) => s + p.total, 0);
    const additionalTotal = additionalItemsArray.reduce((s, it) => s + it.price * it.quantity, 0);
    const grandTotal = productsTotal + additionalTotal;

    const receiptNo = getNextReceiptNumber(); // NEW
    const currentDate = getTodayDate();       // NEW

    document.getElementById('receiptContent').innerHTML = `
        <div class="bg-gradient-to-br from-blue-50 to-indigo-100 p-8 rounded-2xl border border-gray-200">
            <div class="text-center border-b-2 border-indigo-200 pb-6 mb-8">
                <div class="bg-indigo-600 text-white p-4 rounded-xl mb-4 inline-block">
                    <h1 class="text-3xl font-bold">üè¢ BENEDICTORY WOOD PANELS</h1>
                </div>
                <p class="text-indigo-700 text-lg font-medium">Professional Plywood Solutions</p>
                <div class="grid grid-cols-2 gap-4 mt-6 text-sm bg-white p-4 rounded-lg">
                    <div class="text-left"><span class="text-gray-600">Receipt No:</span><br /><strong class="text-indigo-600 text-lg">${receiptNo}</strong></div>
                    <div class="text-right"><span class="text-gray-600">Date:</span><br /><strong class="text-indigo-600 text-lg">${currentDate}</strong></div>
                </div>
            </div>

            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Client Details:</h3>
                <p class="text-gray-700"><strong>Name:</strong> ${clientName}</p>
            </div>

            <div class="mb-8">
                <h3 class="text-xl font-bold text-indigo-800 mb-4">üìã Products Ordered</h3>
                <div class="bg-white p-6 rounded-xl shadow-md overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-purple-100">
                            <tr>
                                <th class="text-left p-3 font-semibold text-purple-800">Thickness</th>
                                <th class="text-left p-3 font-semibold text-purple-800">Quality/Grade</th>
                                <th class="text-left p-3 font-semibold text-purple-800">Size</th>
                                <th class="text-right p-3 font-semibold text-purple-800">Sq Ft</th>
                                <th class="text-right p-3 font-semibold text-purple-800">Rate/Sq Ft</th>
                                <th class="text-right p-3 font-semibold text-purple-800">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${productsArray
                                .map(
                                    (p) => `
                                    <tr class="border-b border-gray-200">
                                        <td class="p-3 font-medium">${p.thickness}</td>
                                        <td class="p-3">${p.quality}</td>
                                        <td class="p-3">${p.size}</td>
                                        <td class="p-3 text-right">${p.sqft.toFixed(2)}</td>
                                        <td class="p-3 text-right">‚Çπ${p.pricePerSqft.toFixed(2)}</td>
                                        <td class="p-3 text-right font-bold">${fmtINR(p.total)}</td>
                                    </tr>`
                                )
                                .join('')}
                        </tbody>
                    </table>
                </div>
            </div>

            ${additionalItemsArray.length > 0
                ? `
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-indigo-800 mb-4">üì¶ Additional Items</h3>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        ${additionalItemsArray
                            .map(
                                (item) => `
                                <div class="flex justify-between items-center py-2 border-b border-gray-200 last:border-b-0">
                                    <div><span class="font-medium">${item.name}</span><span class="text-gray-500 text-sm ml-2">(Qty: ${item.quantity})</span></div>
                                    <span class="font-bold">${fmtINR(item.price * item.quantity)}</span>
                                </div>`
                            )
                            .join('')}
                    </div>
                </div>`
                : ''}

            <div class="mb-8">
                <h3 class="text-xl font-bold text-indigo-800 mb-4">üí∞ Billing Summary</h3>
                <div class="bg-white p-6 rounded-xl shadow-md space-y-3">
                    <div class="flex justify-between text-lg"><span class="text-gray-700">Products Total:</span><span class="font-bold">${fmtINR(productsTotal)}</span></div>
                    ${additionalTotal > 0 ? `<div class="flex justify-between text-lg"><span class="text-gray-700">Additional Items:</span><span class="font-bold">${fmtINR(additionalTotal)}</span></div>` : ''}
                    <div class="bg-gradient-to-r from-green-500 to-emerald-500 text-white p-4 rounded-xl">
                        <div class="flex justify-between items-center text-2xl font-bold"><span>üí≥ Grand Total:</span><span>${fmtINR(grandTotal)}</span></div>
                    </div>
                </div>
            </div>

            <div class="text-center text-sm text-gray-600 border-t-2 border-gray-200 pt-4">
                <p>Thank you for your business!</p>
                <p class="mt-2">For queries, contact: +91-XXXXX-XXXXX | info@benedictorywoodpanels.com</p>
            </div>
        </div>`;

    show(document.getElementById('receiptModal'));
}
